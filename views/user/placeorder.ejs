<section class="banner-bottom-wthreelayouts py-lg-5 py-3">
    <div class="container">
        <div class="inner-sec-shop px-lg-4 px-3">
            <h3 class="tittle-w3layouts my-lg-4 mt-3">Checkout </h3>
            <div class="checkout-right">
                <h4>Your shopping cart contains:
                    <span>
                        <%= cartlength %> Products
                    </span>
                </h4>
                <table class="timetable_sub">
                    <thead>
                        <tr>
                            <th>SL No.</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Product Name</th>
                            <th>Price</th>                         
                        </tr>
                    </thead>
                    <% cartproduct.forEach((cartitem,index)=>{ %>
                <tbody>
                            <tr class="rem1">
                                <td class="invert"><%= index+1 %></td>
                                <td class="invert-image">
                                    <a href="/singlepage/<%= cartitem.product._id%>">
                                        <img src="/image/<%= cartitem.product._id%>.jpeg" alt=" "
                                            class="img-responsive">
                                    </a>
                                </td>
                                <td class="invert">
                                    <div class="quantity">
                                        <div class="quantity-select"> 
                                            <div class="entry value">
                                                <span><%= cartitem.qty %></span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="invert">
                                    <%= cartitem.product.brand %>
                                </td>

                                <td class="invert">$<%= cartitem.price %>.00</td>
                                
                            </tr>

                        </tbody>
                        <%})%>
                </table>
            </div>
            <div class="checkout-left row">
                <div class="col-md-4 checkout-left-basket">
                    <h4><a href="/cart/<%= user._id %>" class="text-white">Back to Cart</a></h4>
                    <ul>
                        <% cartproduct.forEach((cartitem)=>{ %>
                        <li><%= cartitem.product.productname%>
                            <i>-</i>
                            <span>$<%= cartitem.price %>.00 </span>
                        </li>
                        <%})%>
                        <hr>
                        <li>Total
                            <i>-</i>
                            <span>$<%= total %>.00</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-8 address_form">
                    <h4>Add a new Details</h4>
                    <form id="checkout-form">
                        <section class="creditly-wrapper wrapper">
                            <div class="information-wrapper">
                                <div class="first-row form-group">
                                    <div class="controls" style="display: none;" >
                                        <input type="text" value="<%= user._id %>" name="userid">
                                        </div>
                                                      
                                    <div class="controls">
                                        <label class="control-label">Full name: </label>
                                        <input class="billing-address-name form-control" type="text" name="name"
                                            value="<%= user.fname %>">
                                    </div>
                                    <div class="card_number_grids">
                                        <div class="card_number_grid_left">
                                            <div class="controls">
                                                <label class="control-label">Mobile number:</label>
                                                <input class="form-control" type="text" value="<%= user.phone %>" name="phone">
                                            </div>
                                        </div>
                                    </div>
                                        <div class="controls">
                                            <label class="control-label">Select address </label>
                                            <select class="form-control option-w3ls" name="address">
                                                <option></option>
                                                <% address.forEach((addr)=>{%>
                                                    <option>
                                                        <%= addr.housename %>,
                                                            <%= addr.street %>,
                                                                <%= addr.city %>,
                                                                    <%= addr.state %>,
                                                                        <%= addr.pincode %>
                                                    </option>
                                                    <%})%>

                                            </select>
                                        </div>
                                        <div class="text-right mt-5">
                                            <button class="btn" style="background-color: #ff4e00;"><a href="/addaddress" class="text-white">Add address</a></button>
                                          </div>
                                        <div class="controls">
                                            <label class="control-label">Select payment type </label>
                                            <select class="form-control option-w3ls" name="paymentmethod">
                                                <option value="cod">Cash on Delivery</option>                                               
                                                <option value="card"> Card</option>
                                            </select>
                                        </div>
                                   
                                   
                                    

                                  
                                </div>
                                <div class="checkout-right-basket">
                                    <button type="submit" class="btn btn-dark">Place Order</button>
                                </div>
                        </section>
                        
                    </form>
               
                   
</div>
</div>

</div>

<div class="clearfix"> </div>

</div>

</div>

</div>
</section>

<script>
    
    $("#checkout-form").submit((e)=>{ 
   e.preventDefault()
    $.ajax({
        url:'/placeorder',
        type:'POST',
        data:$('#checkout-form').serialize(),
        dataType:'text',
       success:(response)=>{ 
     console.log(response) 
 if(response.success){
     location.href ='/user/orderconfirmation'
 }else{
    razorPayment(response)
    console.log(response)
    }
    } 
    }) 
    })


     function razorPayment(order){
       var options = {
   "key": "rzp_test_8rQGV8fr9QRNn8", // Enter the Key ID generated from the Dashboard
   "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
   "currency": "INR",
   "name": "Anoop",
   "description": "Test Transaction",
   "image": "https://example.com/your_logo",
   "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
   "handler": function (response){
       verifyPayment(response,order)
   },
   "prefill": {
       "name": "Gaurav Kumar",
       "email": "gaurav.kumar@example.com",
       "contact": "9999999999"
   },
   "notes": {
       "address": "Razorpay Corporate Office"
   },
   "theme": {
       "color": "#3399cc"
   }
};
var rzp1 = new Razorpay(options);
 rzp1.open();
     }

     function verifyPayment(payment,order){
       $.ajax({
         url:'/user/verify-payment',
         data:{
            payment:payment,
            order:order
         },
         method:'POST',
     success:(response)=>{ 
     alert(response) 
 if(response.status){
     location.href ='/user/orderconfirmation'
 }else{
  alert('payment failed')

 }
     } 
     }) 
       
     }
</script>